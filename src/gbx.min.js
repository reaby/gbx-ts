/* GBXjs 0.6.0 - (c) Petr Pivonka & Tom - released under MIT */
!function(t,n){"function"==typeof define&&define.amd?define(n):"object"==typeof exports?module.exports=n():t.GBX=n()}(this,function(){var t,n,e,r,o,u,h,m,s,l,c=[],d=[],b=new TextDecoder,p={6:"Stadium",11:"Valley",12:"Canyon",13:"Lagoon",25:"Stadium256",26:"Stadium®",10003:"Common"};function g(t){f=this.read,t.data.constructor===Uint8Array||t.force?T(t,f):async function(){var n;t.data=new Uint8Array(await(n=t.data,new Promise((t,e)=>{let a=new FileReader;a.addEventListener("loadend",n=>t(n.target.result)),a.addEventListener("error",e),a.readAsArrayBuffer(n)}))),T(t,f)}()}function T(t,n){t.thumbnail&&(this.thumb=t.thumbnail),this.onParse=t.onParse,this.onThumb=t.onThumb,this.buffer=t.data,void 0!==this.buffer?n(this.buffer):h=1}function y(t){u=t,m=0}function v(){return r=u[m],m+=1,r}function k(t){for(o=new Uint8Array(t),i=0;i<t;i++)o[i]=v();return o}function S(){return(o=k(4))[0]|o[1]<<8|o[2]<<16|o[3]<<24}function U(){return(o=k(8))[0]|o[1]<<8|o[2]<<16|o[3]<<24|o[4]<<32|o[5]<<40|o[6]<<48|o[7]<<56}function w(t){return null==t&&(t=S()),b.decode(k(t))}function C(){return w(1)}function I(){null==s&&(s=S());var t=new Uint32Array([S()])[0];if(0==(16383&t)&&(t>>30==1||t>>30==-2)){var n=w();return d.push(n),n}if(16383!=(16383&t))return t>>30==0?null==p[t]?(h=10,t):p[t]:d.Count>(16383&t)-1?d[(16383&t)-1]:"";switch(t>>30){case 2:return"Unassigned";case 3:return"";default:h=5}}function x(){return{id:I(),collection:I(),author:I()}}function z(){return!!S()}function D(){return S().toFixed(2)}function M(){return{x:D(),y:D()}}function V(t){return btoa(new Uint8Array(t).reduce(function(t,n){return t+String.fromCharCode(n)},""))}function A(t){return void 0===t?"Trackmania 1":"Trackmania"==t||t.match(/^OrbitalDev@/g)?"Trackmania®":"TMCE@nadeolabs"==t||"TMTurbo@nadeolabs"==t?"Trackmania Turbo":"ManiaPlanet"}return g.prototype.read=function(){if(l=[],c=[],m=0,h=0,s=null,u=this.buffer,"GBX"==w(3)){if((t=(o=k(2))[0]|o[1]<<8)>=3&&(C(),C(),C(),t>=4&&C(),n=S(),t>=6&&S()>0)){for(e=S(),a=0;a<e;a++){var i=4095&S(),r=S(),d=0!=(r&1<<31);c[i]={size:2147483647&r,isHeavy:d}}for(var f in c)c[f].data=k(c[f].size),delete c[f].size;if(50606080==n||603992064==n){l.type="Map",y(c[2].data),(p=v())<3&&(l.mapInfo=x(),l.mapName=w()),S(),p>=1&&(l.bronzeTime=S(),l.silverTime=S(),l.goldTime=S(),l.authorTime=S(),2==p&&v(),p>=4&&(l.cost=S(),p>=5&&(l.isMultilap=z(),6==p&&z(),p>=7&&(l.trackType=S(),p>=9&&(S(),p>=10&&(l.authorScore=S(),p>=11&&(l.editorMode=S(),l.isSimple=0!=(1&l.editorMode),l.hasGhostBlocks=0!=(2&l.editorMode),p>=12&&(z(),p>=13&&(l.nbCheckpoints=S(),l.nbLaps=S()))))))))),y(c[3].data);var b=v();l.mapInfo=x(),l.mapName=w(),l.mapNameD=l.mapName.replace(/(\$)\$|\$([a-f0-9]{2,3}|[lh]\[.*?\]|.)/gi,"$1"),6==v()&&(h=4),b>=1&&(l.locked=z(),l.password=w(),b>=2&&(l.decoration=x(),b>=3&&(l.mapOrigin=M(),b>=4&&(l.mapTarget=M(),b>=5&&(U(),U(),b>=6&&(l.mapType=w(),l.mapStyle=w(),b<=8&&z(),b>=8&&(l.lightmapCacheUID=V(k(8)),b>=9&&(l.lightmapVersion=v(),b>=11&&(l.titleUID=I()))))))))),l.game=A(l.titleUID),y(c[5].data),l.xml=w(),b>5&&(y(c[8].data),S(),l.authorVersion=S(),l.authorLogin=w(),l.authorNickname=w(),l.authorZone=w(),l.authorExtraInfo=w())}else if(50933760==n||604495872==n||604237824==n){l.type="Replay",y(c[0].data),chunk000Version=S(),chunk000Version>=2&&(l.mapInfo=x(),l.time=S(),l.driverNickname=w(),chunk000Version>=6&&(l.driverLogin=w(),chunk000Version>=8&&(v(),l.titleUID=I()))),l.game=A(l.titleUID),y(c[1].data),l.xml=w();try{y(c[2].data);var p=S();l.authorVersion=S(),l.authorLogin=w(),l.authorNickname=w(),l.authorZone=w(),l.authorExtraInfo=w()}catch(t){}}else h=3}}else h=2;(void 0!==this.onParse&&this.onParse.length>0&&this.onParse(l,h,c,n),this.thumb)&&(y(c[7].data),0!=S()&&(l.thumbnailSize=S(),a,w("<Thumbnail.jpg>".length),0==l.thumbnailSize?l.thumbnail=null:l.thumbnail=k(l.thumbnailSize),w("</Thumbnail.jpg>".length),w("<Comments>".length),l.comments=w(),w("</Comments>".length)),"base64"==this.thumb&&(l.thumbnail=V(l.thumbnail)));void 0!==this.onThumb&&this.onThumb.length>0&&this.onThumb(l.thumbnail,l.thumbnailSize,c)},g});